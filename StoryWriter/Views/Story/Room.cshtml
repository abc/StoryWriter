@model StoryWriter.Models.Room

@{
    ViewBag.Title = "Room";
}

<h2>Welcome to @Model.Name <small>Invite Code: @Model.Code</small></h2>

<h3>Co-Authors:</h3>
<ul id="user-list">
    @foreach (var user in Model.Writers)
    {
        <li id="user-list-item">
            @user.Name
        </li>
    }
</ul>

<h3>The story so far:</h3>

<div class="story-body" id="story-body">
   @Html.Partial("StoryText", Model.Story)
</div>

<form action="~/Story/AddLine/@Model.Code" method="post">
    @Html.AntiForgeryToken()
    <label for="nextLine">Next line of the story:</label>
    <input size="120" maxlength="120" name="nextLine" id="nextLine" type="text" placeholder="And then, suddenly..." />
</form>

<div id="vote-container">
    <form id="vote-area">

    </form>
</div>

<div>
    <a href="~/Story/LeaveRoom">Leave this room</a>
</div>

@section Scripts {
    <script>
        let displayedVote = false;

        function update() {
            let fragmentText = $("#nextLine").val();

            var vote = $('#vote-area').find('input[name="vote"]').val();
            var update = { SenderId: "@Session[SessionVariables.UserId]", Fragment: fragmentText, FragmentId: vote };
            

            $.ajax({
                url: "@Url.Content("~/Story/Update/" + Model.Code)",
                data: update,
            })

                .done(function (data) {
                    $("#user-list").html("");
                    data.WritersPresent.forEach((element) => {
                         $("#user-list").append("<li>" + element.Name + "</li>");
                    });

                    if (data.VotesChanged) {
                        displayedVote = false;
                    }

                    if (data.TimeToVote) {
                        let fragments = data.FragmentsThisRound;

                        if (!displayedVote) {
                            $("#vote-area").empty();

                            fragments.forEach((element) => {
                                $("#vote-area").append("<div><input type=\"radio\" id=\"radio-"+element.Identifier+"\" name=\"vote\" value=\""+element.Identifier+"\">" + element.Text + "</input></div>")
                            });

                            displayedVote = true;
                        }
                    }

                    if (data.StoryUpdated) {
                        $.ajax({
                            url: "@Url.Content("~/Story/StoryText/" + Model.Code)",
                        })
                            .done(function (story) {
                                $("#story-body").html(story);
                            });
                    }

                if ( console && console.log ) {
                    console.log( data );
                }
            });
        }

        setInterval(function () {
            update();
        }, 1000);
    </script>
}